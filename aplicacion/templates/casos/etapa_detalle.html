{% extends 'casos/base_casos.html' %}
{% load static %}

{% block title %}{{ caso.caso }} - Partes del Cuerpo{% endblock %}

{% block content %}
<head>
    <title>Etapa {{ etapa_actual_numero }}: {{ etapa.nombre }}</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link rel="stylesheet" href="{% static 'css/casos.css' %}">
    <link rel="stylesheet" href="{% static 'css/etapa_detalle.css' %}">
</head>

<body>
    <div class="container">
        <div class="etapa-card">
            <div class="etapa-header">
                <h2>Etapa {{ etapa_actual_numero }} de {{ total_etapas }}: {{ etapa.nombre }}</h2>
                <p>Caso: <strong>{{ caso.caso }}</strong> | Paciente: <strong>{{ paciente.nombre }}</strong></p>
            </div>

            <!-- CONTENIDO ESPECÍFICO POR TIPO DE ETAPA -->
            {% if etapa.tipo == 'video_inicial' and embed_url %}
                <!-- VIDEO INICIAL -->
                <div class="video-section">
                    <h3><i class="fas fa-video"></i> Motivo de consulta </h3>
                    <p class="video-description">Mire atentamente el siguiente video antes de continuar:</p>
                    
                    <div class="video-container">  
                        <iframe width="560" height="315"
                            src="{{ embed_url }}"
                            title="YouTube video player"
                            frameborder="0"
                            allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share"
                            referrerpolicy="strict-origin-when-cross-origin"
                            allowfullscreen>
                        </iframe>

                    </div>
                    
                    
                    <div id="video-completado" class="video-completion" style="display: none;">
                        <div class="retroalimentacion-box retroalimentacion-correcta">
                            <i class="fas fa-check-circle"></i> Puede continuar
                        </div>
                    </div>
                </div>

            {% elif etapa.tipo == 'formulario_temas' and temas %}
                <!-- FORMULARIO DE TEMAS -->
                <div class="temas-header">
                    <h3><i class="fas fa-clipboard-list"></i> Revise el listado de posibles preguntas</h3>
                        <p class="temas-description">Marque las preguntas que desea consultar al paciente:</p>
                </div>
                
                <div class="temas-grid">
                    {% for tema in temas %}
                        <div class="tema-card" onclick="mostrarOpcionesTema({{ tema.id }})" id="tema-{{ tema.id }}">
                            <div class="tema-icono">
                                <i class="{{ tema.icono }}"></i>
                            </div>
                            <h4>{{ tema.nombre }}</h4>
                            <p class="tema-descripcion">{{ tema.descripcion|truncatewords:15 }}</p>
                            <button class="tema-btn">
                                <i class="fas fa-arrow-right"></i> Evaluar
                            </button>
                        </div>
                    {% endfor %}
                </div>
                
                <!-- Contenedor para opciones dinámicas -->
                <div id="opciones-container" class="opciones-container"></div>
                
                <!-- Retroalimentación -->
                <div id="retroalimentacion-tema" class="retroalimentacion-box"></div>

            {% elif etapa.tipo == 'preguntas_tema' and preguntas %}
                <!-- PREGUNTAS SOBRE TEMA -->
                <div class="preguntas-header">
                    <h3><i class="fas fa-question-circle"></i> Preguntas sobre: {{ etapa.tema }}</h3>
                </div>
                
                <div class="preguntas-container">
                    {% for pregunta in preguntas %}
                        <div class="pregunta-box" id="pregunta-{{ pregunta.id }}">
                            <h4>{{ pregunta.pregunta }}</h4>
                            <div class="opciones-pregunta">
                                {% for respuesta in pregunta.respuestas.all %}
                                    <div class="opcion-pregunta" 
                                         data-respuesta-id="{{ respuesta.id }}"
                                         data-correcta="{{ respuesta.correcta|yesno:'true,false' }}"
                                         onclick="seleccionarRespuesta(this, '{{ respuesta.retroalimentacion|escapejs }}')">
                                        {{ respuesta.texto }}
                                    </div>
                                {% endfor %}
                            </div>
                        </div>
                    {% endfor %}
                </div>
                
                <div id="retroalimentacion-pregunta" class="retroalimentacion-box"></div>

            {% elif etapa.tipo == 'video_respuesta' and embed_url %}
                <!-- VIDEO DE RESPUESTA -->
                <div class="video-section">
                    <h3><i class="fas fa-video"></i> Explicación: {{ etapa.tema }}</h3>
                    <p class="video-description">Esta explicación complementa la evaluación realizada:</p>
                    
                    <div class="video-container">
                        <iframe 
                            width="100%" 
                            height="500" 
                            src="{{ embed_url }}" 
                            title="YouTube video player" 
                            frameborder="0" 
                            allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" 
                            referrerpolicy="no-referrer-when-downgrade"
                            allowfullscreen>
                        </iframe>
                    </div>
                    
                    <div id="video-respuesta-completado" class="video-completion" style="display: none;">
                        <div class="retroalimentacion-box retroalimentacion-correcta">
                            <i class="fas fa-check-circle"></i> Video visto. Puede continuar.
                        </div>
                    </div>
                </div>

            {% elif etapa.tipo == 'tratamientos' or etapa.tipo == 'diagnosticos' %}
                <!-- TRATAMIENTOS O DIAGNÓSTICOS -->
                <div class="evaluacion-completa">
                    <h3><i class="fas fa-stethoscope"></i> {{ etapa.nombre }}</h3>
                    <p class="evaluacion-description">Resumen de hallazgos y recomendaciones:</p>
                    
                    <div class="completado-box">
                        <h4><i class="fas fa-clipboard-check"></i> Evaluación completada</h4>
                        <p>Ha finalizado la evaluación del paciente. Puede revisar el progreso completo.</p>
                        
                        <div class="progreso-actions">
                            <a href="{% url 'Caso_Clinico:ver_progreso' caso.id parte.id paciente.id %}" 
                               class="btn-progreso">
                                <i class="fas fa-chart-line"></i> Ver progreso completo
                            </a>
                        </div>
                    </div>
                </div>

            {% else %}
                <div class="contenido-no-disponible">
                    <i class="fas fa-exclamation-triangle"></i>
                    <p>Contenido no disponible para esta etapa.</p>
                </div>
            {% endif %}

            <!-- Navegación -->
            <div class="nav-buttons">
                {% if etapa_anterior %}
                    <a href="{% url 'Caso_Clinico:etapa_detalle' caso.id parte.id paciente.id etapa_anterior.id %}" 
                       class="btn-nav btn-anterior">
                        <i class="fas fa-arrow-left"></i> Anterior
                    </a>
                {% else %}
                    <a href="{% url 'Caso_Clinico:ver_etapas' caso.id parte.id paciente.id %}" 
                       class="btn-nav btn-anterior">
                        <i class="fas fa-list"></i> Ficha Clínica
                    </a>
                {% endif %}

                {% if etapa_siguiente and etapa.tipo != 'formulario_temas' %}
                    <button class="btn-nav btn-siguiente" id="btnSiguiente" onclick="window.location.href='{% url 'Caso_Clinico:etapa_detalle' caso.id parte.id paciente.id etapa_siguiente.id %}'">
                        Siguiente <i class="fas fa-arrow-right"></i>
                    </button>
                {% elif not etapa_siguiente and etapa.tipo == 'tratamientos' or etapa.tipo == 'diagnosticos' %}
                    <a href="{% url 'Caso_Clinico:detalle_caso' caso.id %}" 
                       class="btn-nav btn-siguiente habilitado btn-finalizar">
                        Finalizar Caso <i class="fas fa-check"></i>
                    </a>
                {% else %}
                    <button class="btn-nav btn-siguiente" id="btnSiguiente" disabled>
                        Siguiente <i class="fas fa-arrow-right"></i>
                    </button>
                {% endif %}
            </div>
        </div>
    </div>
    <script src="{% static 'js/etapa_detalle.js' %}"></script>
       
<script>
// Función para mostrar opciones de tema
function mostrarOpcionesTema(temaId) {
    console.log('Solicitando opciones para tema:', temaId);
    
    // URL de la API - AJUSTA ESTA URL SEGÚN TU PROYECTO
    const url = `/casos/api/opciones-tema/${temaId}/`;
    
    fetch(url)
        .then(response => {
            if (!response.ok) {
                throw new Error('Error en la petición: ' + response.status);
            }
            return response.json();
        })
        .then(data => {
            console.log('Respuesta recibida:', data);
            
            if (data.success && data.opciones.length > 0) {
                const container = document.getElementById('opciones-container');
                container.innerHTML = `
                    <div class="opciones-tema" id="opciones-tema-${temaId}" style="display: block;">
                        <h4>Seleccione una opción para este tema:</h4>
                        ${data.opciones.map(opcion => `
                            <div class="opcion-tema" 
                                 onclick="seleccionarOpcionTema(${opcion.id}, ${temaId}, ${opcion.es_correcta}, '${opcion.retroalimentacion.replace(/'/g, "\\'")}')">
                                <strong>${opcion.texto}</strong>
                            </div>
                        `).join('')}
                    </div>
                `;
            } else {
                alert('No hay opciones disponibles para este tema.');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Error al cargar opciones. Verifica la consola para más detalles.');
        });
}

// Función para seleccionar opción de tema
function seleccionarOpcionTema(opcionId, temaId, esCorrecta, retroalimentacion) {
    console.log('Opción seleccionada:', {opcionId, temaId, esCorrecta, retroalimentacion});
    
    const retroDiv = document.getElementById('retroalimentacion-tema');
    const temaCard = document.getElementById(`tema-${temaId}`);
    
    // Marcar tema como completado
    if (temaCard) {
        temaCard.style.borderColor = esCorrecta ? '#28a745' : '#dc3545';
        temaCard.style.background = esCorrecta ? '#f0fff4' : '#fff0f0';
        
        const boton = temaCard.querySelector('button');
        if (boton) {
            boton.innerHTML = esCorrecta ? 
                '<i class="fas fa-check"></i> Correcto' : 
                '<i class="fas fa-times"></i> Incorrecto';
            boton.style.background = esCorrecta ? '#28a745' : '#dc3545';
            boton.disabled = true;
        }
    }
    
    // Mostrar retroalimentación
    retroDiv.className = `retroalimentacion-box ${esCorrecta ? 'retroalimentacion-correcta' : 'retroalimentacion-incorrecta'}`;
    retroDiv.innerHTML = `
        <h4><i class="fas fa-${esCorrecta ? 'check-circle' : 'exclamation-circle'}"></i> 
        ${esCorrecta ? '¡Correcto!' : 'Incorrecto'}</h4>
        <p>${retroalimentacion}</p>
        ${esCorrecta ? '<p><strong>Este tema ha sido completado.</strong></p>' : ''}
    `;
    retroDiv.style.display = 'block';
    
    // Verificar si todos los temas están completados
    verificarTemasCompletados();
}

// Función para verificar si todos los temas están completados
function verificarTemasCompletados() {
    const temasCards = document.querySelectorAll('.tema-card');
    let todosCompletados = true;
    
    temasCards.forEach(card => {
        const boton = card.querySelector('button');
        if (boton && !boton.disabled) {
            todosCompletados = false;
        }
    });
    
    // Habilitar botón siguiente si todos los temas están completados
    const btnSiguiente = document.getElementById('btnSiguiente');
    if (btnSiguiente && todosCompletados) {
        btnSiguiente.classList.add('habilitado');
        btnSiguiente.disabled = false;
        btnSiguiente.onclick = function() {
            window.location.href = "{% url 'Caso_Clinico:detalle_caso' caso.id %}";
        };
    }
}

</script>

{% endblock %}
</body>
</html>