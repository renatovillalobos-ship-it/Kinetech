{% load static %}

<div class="ajax-cuestionario">
    <div class="text-center mb-4">
        <img src="{% static 'img/logo_ucn.jpg' %}" 
             alt="" 
             style="height:80px; border-radius: 50%;" 
             class="mb-2">

        <h2 class="fw-bold text-primary">
            {% if cuestionario_actual.nombre == 'Inicial' %}
                Cuestionario Inicial
            {% else %}
                Cuestionario Final
            {% endif %}
        </h2>

        <p class="text-muted">
            {% if cuestionario_actual.nombre == 'Inicial' %}
                Evaluación de conocimientos previos
            {% else %}
                Evaluación final del curso
            {% endif %}
        </p>
    </div>

    <!-- Mostrar nivel de diagnóstico si ya se respondido -->
    {% if cuestionario_respondido %}
    <div class="alert alert-success text-center mb-4 mx-auto" style="max-width:650px;" id="nivelDiagnostico">
        <h4 class="fw-bold mb-2">
            {% if nivel_diagnostico == 'alta' %}
                Nivel de diagnóstico: Alto
            {% elif nivel_diagnostico == 'media' %}
                Nivel de diagnóstico: Medio
            {% elif nivel_diagnostico == 'baja' %}
                Nivel de diagnóstico: Bajo
            {% endif %}
        </h4>
        <p class="mb-0">
            {% if nivel_diagnostico == 'alta' %}
                ¡Excelente!
            {% elif nivel_diagnostico == 'media' %}
                Buen trabajo, pero hay áreas para mejorar.
            {% elif nivel_diagnostico == 'baja' %}
                Te recomendamos revisar los contenidos.
            {% endif %}
        </p>
        <p class="mt-2 mb-0 text-muted">
            Puntaje: {{ porcentaje_correctas|floatformat:0 }}% ({{ respuestas_correctas }}/{{ total_preguntas }})
        </p>
    </div>
    {% endif %}

    <div class="alert alert-info text-start mb-4 mx-auto" style="max-width:650px;">
        <strong>Instrucciones:</strong> 
        {% if cuestionario_respondido %}
            Este cuestionario ya ha sido respondido. Puedes revisar tus respuestas.
        {% else %}
            Responde todas las preguntas antes de enviar y selecciona una alternativa por pregunta.
        {% endif %}
    </div>

    <form id="cuestionarioForm"
          method="POST"
          data-url-guardar="{% url 'estudiante:ajax_guardar_respuestas' curso_id cuestionario_id %}"
          data-section="cuest-{{ cuestionario_id }}"
          {% if cuestionario_respondido %}data-respondido="true"{% endif %}
          style="max-width:680px; margin: 0 auto;">

        {% csrf_token %}

        <h4 class="text-start mb-4">
            Total de preguntas: {{ preguntas|length }}
            {% if cuestionario_respondido %}
                <span class="badge bg-secondary ms-2">Ya respondido</span>
            {% endif %}
        </h4>

        {% for pregunta in preguntas %}
        <div class="pregunta-card mb-4" data-index="{{ forloop.counter0 }}">
            <div class="d-flex flex-row align-items-center mb-2">
                <span class="badge bg-primary me-2" style="font-size:1.2em;">
                    {{ forloop.counter }}
                </span>
                <h5 class="fw-bold mb-0">{{ pregunta.enunciado }}</h5>
            </div>

            <hr>

            {% for respuesta in pregunta.respuesta_set.all %}
            <div class="form-check mb-2">
                {% if cuestionario_respondido %}
                    {# Obtener la respuesta del estudiante para esta pregunta #}
                    {% with respuesta_id=respuestas_estudiante.get|default:0 %}
                    <input class="form-check-input"
                           type="radio"
                           name="pregunta_{{ pregunta.id }}"
                           id="respuesta_{{ respuesta.id }}"
                           value="{{ respuesta.id }}"
                           {% if respuesta_id == respuesta.id %}checked{% endif %}
                           disabled>
                    
                    <label class="form-check-label" for="respuesta_{{ respuesta.id }}">
                        {{ respuesta.retro }}
                        {# Marcar respuestas correctas e incorrectas #}
                        {% if respuesta.es_correcta %}
                            <span class="badge bg-success ms-2">✓ Correcta</span>
                        {% elif respuesta_id == respuesta.id and not respuesta.es_correcta %}
                            <span class="badge bg-danger ms-2">✗ Tu respuesta</span>
                        {% endif %}
                    </label>
                    {% endwith %}
                {% else %}
                    <input class="form-check-input"
                           type="radio"
                           name="pregunta_{{ pregunta.id }}"
                           id="respuesta_{{ respuesta.id }}"
                           value="{{ respuesta.id }}">
                    
                    <label class="form-check-label" for="respuesta_{{ respuesta.id }}">
                        {{ respuesta.retro }}
                    </label>
                {% endif %}
            </div>
            {% endfor %}
        </div>
        {% endfor %}

        <div class="d-flex justify-content-end gap-3 mt-4 mb-5">
            {% if not cuestionario_respondido %}
            <button type="submit" id="btnEnviar" class="btn btn-success btn-lg px-4">
                Enviar respuestas
            </button>
            {% else %}
            <button type="button" class="btn btn-secondary btn-lg px-4" disabled>
                Cuestionario completado
            </button>
            {% endif %}
        </div>
    </form>
</div>